\section{Transaction Model}
本章では、4章で定義したテンプレート枠組みを「トランザクションの型（classes）」として一般形としての作成・実行・確定の流れを定める。

\subsection{状態の担体}
テンプレートは次の構造を持つプロトコル定数として与える。
\begin{equation}
	\tau := (\mathsf{tid}, \mathsf{ArgSchema}, \mathsf{Logic}, \mathsf{TransSpec}), \quad \tau \in \Gamma
\end{equation}
ここで $\mathsf{Logic}$ は $\mathsf{Pred}$ の実装に相当する検証ロジックである。
インスタンスは
\begin{equation}
	I := (\mathsf{cid}, \mathsf{tid}, \vec{a})
\end{equation}
とし、$\mathsf{cid}$ は $H(\mathsf{deployerAddr} \parallel \mathsf{tid} \parallel \vec{a})$ から決定的に導出される（一意性を要件とする）。ここで $\mathsf{deployerAddr}$ は CreateSC/Lock を作成する主体のアドレスである。

Locked UTXO は
\begin{equation}
	u^\star := (\mathsf{op}, v, \mathsf{cid}, \mathsf{stateTag})
\end{equation}
とし、$\mathsf{stateTag}$ は有限個の状態ラベルである。実装上は $(\mathsf{cid}, \mathsf{stateTag})$ が script / aux / commitment / metadata に埋め込まれ得る抽象化であり、UTXO に独立の data 欄を仮定しない。すなわち、状態は Locked UTXO に担持される。
共有される状態語彙は $\mathsf{stateTag}$ に限定し、これが唯一のグローバルステートである。

\subsection{トランザクションの3クラス}
\paragraph{Contract Creation Transaction（CreateSC）}
テンプレート $\mathsf{tid}$ と引数 $\vec{a}$、および $\mathsf{deployerAddr}$ を参照して $\mathsf{cid}$ を生成するトランザクションである。本章では $\mathsf{cid}$ が決定的に導出されることのみを要件として示す。

\paragraph{Contract Lock Transaction（Lock）}
通常 UTXO $u$ を消費し、Locked UTXO $u^\star$ を出力するトランザクションである。出力には $(\mathsf{cid}, \mathsf{stateTag}=s_{\mathrm{init}})$ が付与される。CreateSC と Lock は実装上同一Txに畳めるが、概念上は分離して記述する。

\paragraph{Contract Execution Transaction（$tx_\ell$）}
Locked UTXO $u^\star$ を入力として消費するトランザクション $tx_\ell$（$\ell$ は遷移ラベル）を指す。型注釈として
\begin{equation}
	\mathsf{Pred}_{\tau,\ell} : \Sigma \times \mathsf{Tx} \times \mathsf{CID} \to \{\mathsf{true}, \mathsf{false}\}, \quad
	\mathsf{TransSpec}_{\tau,\ell} : \Sigma \times \mathsf{CID} \to \mathcal{P}(\mathsf{Out})
\end{equation}
を置く。$\mathsf{Pred}_{\tau,\ell}$ は $\Sigma$ と $tx$ の $\mathsf{in}/\mathsf{out}/\mathsf{aux}$ を参照して決定的に真偽が定まる。$tx_\ell$ が admissible であるとは、(i) $\mathsf{Pred}_{\tau,\ell}(\Sigma, tx, \mathsf{cid})=\mathsf{true}$、かつ (ii) $\mathsf{out}(tx) \in \mathsf{TransSpec}_{\tau,\ell}(\Sigma, \mathsf{cid})$ を満たすことをいう。

継続遷移であれば $\mathsf{out}(tx)$ は次状態の $u^{\star\prime}(\dots,\mathsf{cid}, \mathsf{stateTag}=s')$ を含み、終端遷移であれば受益者への通常 UTXO（およびお釣り等）のみを含む。

\subsection{Finalize / Timeout（Execution の特別なラベル）}
テンプレートは誰でも起動可能な確定遷移を持ち得る。期限経過 $\operatorname{after}(d)$ や $\operatorname{after}(t)$ に対応する遷移ラベル $\ell_{\mathrm{final}}$ を与え、上の admissibility と同じ枠組みで検証可能にする。これにより資金が永久拘束されないこと（liveness/decisiveness）を仕様として扱える。
