\section{Case Study: Escrow Misappropriation Resistance}
\label{sec:case-escrow}

本章ではマーケットプレイス型のエスクロー取引を想定し、買い手・販売者・プラットフォーム運営者の三者モデルでケーススタディを行う。
買い手公開鍵を $\mathsf{pk}_A$、販売者公開鍵を $\mathsf{pk}_B$、運営者（仲介者）公開鍵を $\mathsf{pk}_C$ とし、買い手が価格 $p$ の商品購入を試み、運営者はマージン率 $m$ を設定する。
本ケースは匿名市場に関する先行研究を参照して構成した（\cite{Christin2013,Soska2015,Tzanetakis2016,Spagnoletti2022}）。

\subsection{Notation}
\label{subsec:escrow-notation}

\begin{table}[t]
	\centering
	\small
	\setlength{\tabcolsep}{6pt}
	\renewcommand{\arraystretch}{1.15}
	\begin{tabularx}{0.92\linewidth}{lX}
		\toprule
		記号              & 意味                                                               \\
		\midrule
		$\mathsf{pk}_A$ & 買い手（Buyer）公開鍵                                                    \\
		$\mathsf{pk}_B$ & 販売者（Seller）公開鍵                                                   \\
		$\mathsf{pk}_C$ & 運営者（Operator / Platform）公開鍵                                      \\
		$\mathsf{pk}_M$ & マイナー（block producer）公開鍵                                          \\
		$p$             & 商品価格                                                             \\
		$m$             & マージン率                                                            \\
		$d$             & 配送期限（Unix epoch seconds）                                         \\
		$t$             & コントラクト・タイムアウト（Unix epoch seconds, $t \ge d$）                     \\
		$b$             & Finalize の liveness reward（bounty amount、契約ごとに InitParams でコミット） \\
		\bottomrule
	\end{tabularx}
	\caption{Escrow ケーススタディで用いる記号}
	\label{tab:escrow-notation}
\end{table}

\subsection{Instance Parameters (InitParams / LockParams)}
\label{subsec:escrow-params}

\paragraph{InitParams}
InitParams $=(m,d,t,b)$ は運営者 $\mathsf{pk}_C$ が CreateContract（インスタンス作成）時に確定させるテンプレート固定パラメータであり、
以後の型検証およびテンプレート検証で参照される。
合意対象は canonical encoding された \texttt{init\_params\_bytes} とし、$ (m,d,t,b)$ はそのデコード結果として扱う。
$d,t$ は Unix epoch seconds の整数として扱う。
Bitcoin の locktime が値域によりブロック高／Unix time を切り替えるのに対し、本稿では Unix time に固定する。
$b$ は期限後の Finalize を第三者に実行させるための liveness reward であり、返金・精算の正当性とは独立である。
$b$ は契約ごとに Create 時点でコミットする。
プロトコルは $b_{\min} \le b \le b_{\max}$ の範囲や $b=\min(b_{\mathrm{cap}},\lfloor \alpha \cdot p \rfloor)$ のような比率＋上限を課すことで、恣意・DoSを抑制できる。
ここで $b_{\min}, b_{\max}, b_{\mathrm{cap}}, \alpha$ はプロトコル定数（合意規則）として固定される。
Finalize $tx$ の手数料は別途確保され、$b$ は追加の誘因として扱う。
また、$\mathsf{pk}_{\mathrm{from}} = \mathsf{pk}_C$ とし、CreateContract の $\mathsf{tx}_{id}$ により $c_{id}$ を導出し、例えば
\[
	c_{id} := H(\mathsf{tx}_{id} \parallel \mathsf{pk}_{\mathrm{from}} \parallel \mathsf{t}_{index} \parallel \mathrm{init\_params\_bytes})
\]
のように決定的に定める（同一入力から一意であることが本質）。

\paragraph{LockParams}
LockParams $=(\mathsf{pk}_B,p)$ は買い手 $\mathsf{pk}_A$ が BuyerLock により資金拘束（LockUtxo）を開始する際に与える。
販売者公開鍵 $\mathsf{pk}_B$ と価格 $p$ を指定し、以降の支払い先・返金先の整合性検証に用いる。

\subsection{State Machine and Transition Specification}
\label{subsec:escrow-transitions}

テンプレートが取りうる状態タグ（stateTag）は $S0,S0D,S0X,S0C,S1,S2$ である。
stateTag は $u^\star$ に付随する唯一の共有状態語彙として扱う。
表\ref{tab:escrow-transitions} の各行は $\mathsf{Pred}_{\tau,\ell}$ と $\mathsf{TransSpec}_{\tau,\ell}$ の具体例である。
ここで $\operatorname{after}(d), \operatorname{after}(t)$ は $\mathsf{chain\_time} \ge d,t$ を意味し、$\mathsf{chain\_time}$ は合意的時刻（例：MTP）として評価する。

\begin{table*}[t]
	\centering
	\footnotesize
	\setlength{\tabcolsep}{4pt}
	\renewcommand{\arraystretch}{1.15}
	\begin{tabularx}{\textwidth}{l l l l l X}
		\toprule
		遷移ラベル $\ell$                                                   & 前状態 & 起動者 & 認証/条件 & 次状態 & 効果（主な出力・更新） \\
		\midrule
		BuyerLock                                                      &
		--                                                             &
		$\mathsf{pk}_A$                                                &
		$\sigma_A$                                                     &
		$S0$                                                           &
		$p$ を拘束し $u^\star(c_{id},\mathrm{stateTag}{=}S0)$ を生成                                                  \\

		SellerDeliver                                                  &
		$S0$                                                           &
		$\mathsf{pk}_B$                                                &
		$\sigma_B$                                                     &
		$S0D$                                                          &
		$\mathrm{stateTag}{=}S0D$ に更新（ロック継続）                                                                   \\

		BuyerConfirm                                                   &
		$S0/S0D$                                                       &
		$\mathsf{pk}_A$                                                &
		$\sigma_A$                                                     &
		$S1$                                                           &
		$p(1-m)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C$                                       \\

		FinalizeContract                                               &
		$S0/S0D$                                                       &
		Anyone                                                         &
		$\operatorname{after}(d)$                                      &
		$S1/S2$                                                        &
		$\mathrm{stateTag}$ に応じた支払（下記の支払マップ）                                                                   \\

		BuyerDispute                                                   &
		$S0D$                                                          &
		$\mathsf{pk}_A$                                                &
		$\sigma_A$                                                     &
		$S0X$                                                          &
		$\mathrm{stateTag}{=}S0X$ に更新（ロック継続）                                                                   \\

		OperatorMediateRelease                                         &
		$S0X$                                                          &
		$\mathsf{pk}_C$                                                &
		$\sigma_C$                                                     &
		$S1$                                                           &
		$p(1-m)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C$                                       \\

		OperatorMediateRefund                                          &
		$S0X$                                                          &
		$\mathsf{pk}_C$                                                &
		$\sigma_C$                                                     &
		$S2$                                                           &
		$p\rightarrow \mathsf{pk}_A$                                                                           \\

		BuyerCancel                                                    &
		$S0/S0D$                                                       &
		$\mathsf{pk}_A$                                                &
		$\sigma_A$                                                     &
		$S0C$                                                          &
		$\mathrm{stateTag}{=}S0C$ に更新（ロック継続）                                                                   \\

		SellerAcceptCancel                                             &
		$S0C$                                                          &
		$\mathsf{pk}_B$                                                &
		$\sigma_B$                                                     &
		$S2$                                                           &
		$p\rightarrow \mathsf{pk}_A$                                                                           \\

		ContractTimeout                                                &
		$S0/S0D/S0X/S0C$                                               &
		Anyone                                                         &
		$\mathrm{timeout\_condition}(\mathrm{stateTag})=\mathrm{true}$ &
		$S1/S2$                                                        &
		$\mathrm{stateTag}$ に応じた支払（下記の支払マップ）                                                                   \\
		\bottomrule
	\end{tabularx}
	\caption{Escrow テンプレートの遷移仕様（検証条件・次状態・支払い）}
	\label{tab:escrow-transitions}
\end{table*}

\paragraph{State-dependent payout (Finalize/Timeout)}
TransSpec の終端出力（FinalizeContract/Timeout）は $\mathrm{stateTag}$ に応じた支払マップとして与える。
マイナーが finalize した場合は bounty $b$ がマイナー報酬として支払われ、コントラクトの関係者が finalize した場合は $b$ を支払わない。
基本的には関係者（例：運営者 $\mathsf{pk}_C$）が finalize することを推奨し、関係者の範囲は運営者に限定してもよい。

\[
	\begin{aligned}
		S0  & \Rightarrow p \rightarrow \mathsf{pk}_A                                    \\
		S0D & \Rightarrow p(1-m)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C \\
		S0X & \Rightarrow p \rightarrow \mathsf{pk}_A                                    \\
		S0C & \Rightarrow p \rightarrow \mathsf{pk}_A                                    \\
		S1  & \Rightarrow p(1-m)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C \\
		S2  & \Rightarrow p \rightarrow \mathsf{pk}_A
	\end{aligned}
\]

マイナーによる finalize（$\mathsf{pk}_M$）の場合は次である：
\[
	\begin{aligned}
		S0  & \Rightarrow (p-b)\rightarrow \mathsf{pk}_A,\; b\rightarrow \mathsf{pk}_M                                     \\
		S0D & \Rightarrow (p(1-m)-b)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C,\; b\rightarrow \mathsf{pk}_M \\
		S0X & \Rightarrow (p-b)\rightarrow \mathsf{pk}_A,\; b\rightarrow \mathsf{pk}_M                                     \\
		S0C & \Rightarrow (p-b)\rightarrow \mathsf{pk}_A,\; b\rightarrow \mathsf{pk}_M                                     \\
		S1  & \Rightarrow (p(1-m)-b)\rightarrow \mathsf{pk}_B,\; pm\rightarrow \mathsf{pk}_C,\; b\rightarrow \mathsf{pk}_M \\
		S2  & \Rightarrow (p-b)\rightarrow \mathsf{pk}_A,\; b\rightarrow \mathsf{pk}_M
	\end{aligned}
\]

\subsection{LogicSet, Pred, and TransSpec}
\label{subsec:escrow-logics}

第4章の定義（テンプレート $\tau=(\mathsf{t}_{index},\mathrm{InitParams},\mathrm{LockParams},\mathrm{StateSet},\mathrm{LogicSet},\mathrm{TransSpec})$）に従う。
本節では重複を避けるため、LogicSet の具体は表\ref{tab:escrow-transitions} で一括して与える。
すなわち、各遷移 $\ell$ について
\[
	\mathrm{LogicSet}[\ell]=\mathrm{func}_{\ell}=(\mathrm{args}_{\ell},\mathrm{modifier}_{\ell},\mathrm{post\_state}_{\ell},\mathrm{validation}_{\ell})
\]
を、(i) 「前状態」$\Rightarrow \mathrm{modifier}_{\ell}$、(ii) 「認証/条件」$\Rightarrow \mathrm{validation}_{\ell}$、
(iii) 「次状態」$\Rightarrow \mathrm{post\_state}_{\ell}$、(iv) 「効果」$\Rightarrow \mathrm{TransSpec}_{\tau,\ell}$ として読み替える。

\subsection{Properties}
\label{subsec:escrow-properties}

\paragraph{Safety（運営の持ち逃げ抑止 / misappropriation resistance）}
失敗遷移 $F$（運営が預託資金を自己へ移転、または回収不能化する遷移）を許容遷移から排除することを要件とする。
運用裁量の残余を Disc$(r)$（役割 $r$ の単独署名だけで到達できる資金移動遷移の集合）と定義すると、
本テンプレートでは Disc(Operator) は $S0X$ の仲裁遷移に限定される。
運営者 $\mathsf{pk}_C$ は $S0X$ 以外で単独に $S1/S2$ に到達できず、$S0X$ における解放/返金も受益者・配分は $\mathsf{TransSpec}$ により固定されるため、単独の $F$ を制度（検証規則）として排除する。

\paragraph{Liveness（決着性 / non-deadlock）}
$S0/S0D$ は BuyerConfirm もしくは $\operatorname{after}(d)$ 到来後の FinalizeContract により $S1/S2$ に決着する。
$S0X$ は仲裁（OperatorMediateRelease/Refund）で $S1/S2$ に到達し、最終的には
$\mathrm{timeout\_condition}(\mathrm{stateTag})=\mathrm{true}$ の ContractTimeout により $S2$ に到達する。
さらに FinalizeContract/ContractTimeout は誰でも実行可能であり、期限到来後のフォールバックとして機能する。
